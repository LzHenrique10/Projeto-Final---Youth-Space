{% extends 'base.html' %} {% block content %}

<header class="header">
  <div class="header-content">
    <h1 class="logo">Gerenciamento Escolar</h1>
    <nav>
      <a href="/login" class="nav-link">Sair</a>
    </nav>
  </div>
  <div class="stars"></div>
</header>

<main class="dashboard">
  <aside class="sidebar">
    <ul>
      <li>
        <a href="#" id="link-alunos"><i class="fas fa-users"></i> Alunos</a>
      </li>
      <li>
        <a href="#" id="link-professores"
          ><i class="fas fa-chalkboard-teacher"></i> Professores</a
        >
      </li>
      <li>
        <a href="/cursos/"><i class="fas fa-book"></i> Cursos</a>
      </li>
      <li>
        <a href="/turmas/"><i class="fas fa-layer-group"></i> Turmas</a>
      </li>
    </ul>
  </aside>

  <section class="content">
    <h2>Bem-vindo, {{ user.nome if user else 'Usuário' }}!</h2>

    <div class="summary-cards">
      <div class="card-home">
        <h3>Alunos</h3>
        <p id="total-alunos">{{ total_alunos }}</p>
      </div>
      <div class="card-home">
        <h3>Professores</h3>
        <p id="total-professores">{{ total_professores }}</p>
      </div>
      <div class="card-home">
        <h3>Cursos</h3>
        <p id="total-cursos">{{ total_cursos }}</p>
      </div>
      <div class="card-home">
        <h3>Turmas</h3>
        <p id="total-turmas">{{ total_turmas }}</p>
      </div>
    </div>

    <div class="quick-actions">
      <button id="open-aluno-modal" class="btn">Cadastrar Aluno</button>
      <button id="open-professor-modal" class="btn">Cadastrar Professor</button>
    </div>

    <!-- Modal de cadastro de aluno -->
    <div id="aluno-modal" class="modal">
      <div class="modal-content">
        <button id="close-aluno-modal" class="close-btn-modal">X</button>
        <h3 class="cada-aluno">Cadastrar Aluno</h3>
        <form id="aluno-form">
          <input type="text" name="nome" placeholder="Nome" required />
          <input type="email" name="email" placeholder="Email" required />
          <select name="status">
            <option value="ativo">Ativo</option>
            <option value="inativo">Inativo</option>
          </select>
          <button type="submit" class="btn">Cadastrar</button>
          <p id="aluno-msg" style="margin-top: 10px; color: #ff4b5c"></p>
        </form>
      </div>
    </div>

    <!-- Modal de cadastro de professor -->
    <div id="professor-modal" class="modal">
      <div class="modal-content">
        <button id="close-professor-modal" class="close-btn-modal">X</button>
        <h3 class="cada-professor">Cadastrar Professor</h3>
        <form id="professor-form">
          <input type="text" name="nome" placeholder="Nome" required />
          <input type="email" name="email" placeholder="Email" required />
          <input type="password" name="senha" placeholder="Senha" required />
          <button type="submit" class="btn">Cadastrar</button>
          <p id="professor-msg" style="margin-top: 10px; color: #ff4b5c"></p>
        </form>
      </div>
    </div>

    <!-- Card Alunos -->
    <div id="alunos-container" style="display: none; opacity: 0">
      <div class="alunos-card-modern">
        <button id="close-alunos" class="close-btn">X</button>
        <h3>Alunos Cadastrados</h3>
        <ul id="alunos-list"></ul>
      </div>
    </div>

    <!-- Card Professores -->
    <div id="professores-container" style="display: none; opacity: 0">
      <div class="professores-card-modern">
        <button id="close-professores" class="close-btn">X</button>
        <h3>Professores Cadastrados</h3>
        <ul id="professores-list"></ul>
      </div>
    </div>
  </section>
</main>

<script>
  function abrirCard(container, list, url, vazioMensagem) {
    list.innerHTML = "";
    fetch(url)
      .then((res) => res.json())
      .then((data) => {
        if (!data.length) list.innerHTML = `<li>${vazioMensagem}</li>`;
        else
          data.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.nome} - ${item.email} - ${
              item.status || "ativo"
            }`;
            list.appendChild(li);
          });
        container.style.display = "block";
        setTimeout(() => (container.style.opacity = 1), 10);
      })
      .catch((err) => {
        console.error(err);
        list.innerHTML = `<li>Erro ao carregar os dados.</li>`;
        container.style.display = "block";
        setTimeout(() => (container.style.opacity = 1), 10);
      });
  }

  // ===== ALUNOS =====
  const alunosContainer = document.getElementById("alunos-container");
  const alunosList = document.getElementById("alunos-list");
  const linkAlunos = document.getElementById("link-alunos");
  const closeAlunos = document.getElementById("close-alunos");

  linkAlunos.addEventListener("click", (e) => {
    e.preventDefault();
    abrirCard(
      alunosContainer,
      alunosList,
      "/alunos/",
      "Nenhum aluno cadastrado."
    );
  });

  closeAlunos.addEventListener("click", () => {
    alunosContainer.style.opacity = 0;
    setTimeout(() => (alunosContainer.style.display = "none"), 300);
  });

  // ===== PROFESSORES =====
  const professoresContainer = document.getElementById("professores-container");
  const professoresList = document.getElementById("professores-list");
  const linkProfessores = document.getElementById("link-professores");
  const closeProfessores = document.getElementById("close-professores");

  linkProfessores.addEventListener("click", (e) => {
    e.preventDefault();
    abrirCard(
      professoresContainer,
      professoresList,
      "/professores/",
      "Nenhum professor cadastrado."
    );
  });

  closeProfessores.addEventListener("click", () => {
    professoresContainer.style.opacity = 0;
    setTimeout(() => (professoresContainer.style.display = "none"), 300);
  });

  // ===== MODAL DE CADASTRO DE ALUNO =====
  const openModal = document.getElementById("open-aluno-modal");
  const closeModal = document.getElementById("close-aluno-modal");
  const modal = document.getElementById("aluno-modal");
  const form = document.getElementById("aluno-form");
  const alunoMsg = document.getElementById("aluno-msg");
  const totalAlunosElem = document.getElementById("total-alunos");

  openModal.addEventListener("click", () => modal.classList.add("show"));
  closeModal.addEventListener("click", () => modal.classList.remove("show"));
  window.addEventListener("click", (e) => {
    if (e.target === modal) modal.classList.remove("show");
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(form));
    try {
      const res = await fetch("/alunos/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      if (res.ok) {
        const novoAluno = await res.json();
        totalAlunosElem.textContent = parseInt(totalAlunosElem.textContent) + 1;
        modal.classList.remove("show");
        form.reset();
        alunoMsg.textContent = "";
        alert("Aluno cadastrado com sucesso!");
      } else {
        alunoMsg.textContent = "Erro ao cadastrar aluno!";
      }
    } catch (err) {
      console.error(err);
      alunoMsg.textContent = "Erro na conexão!";
    }
  });

  // ===== MODAL DE CADASTRO DE PROFESSOR =====
  const openProfessorModal = document.getElementById("open-professor-modal");
  const closeProfessorModal = document.getElementById("close-professor-modal");
  const professorModal = document.getElementById("professor-modal");
  const professorForm = document.getElementById("professor-form");
  const professorMsg = document.getElementById("professor-msg");
  const totalProfessoresElem = document.getElementById("total-professores");

  openProfessorModal.addEventListener("click", () =>
    professorModal.classList.add("show")
  );
  closeProfessorModal.addEventListener("click", () =>
    professorModal.classList.remove("show")
  );
  window.addEventListener("click", (e) => {
    if (e.target === professorModal) professorModal.classList.remove("show");
  });

  professorForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(professorForm));
    try {
      const res = await fetch("/professores/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      if (res.ok) {
        const novoProfessor = await res.json();
        totalProfessoresElem.textContent =
          parseInt(totalProfessoresElem.textContent) + 1;
        professorModal.classList.remove("show");
        professorForm.reset();
        professorMsg.textContent = "";
        alert("Professor cadastrado com sucesso!");
      } else {
        professorMsg.textContent = "Erro ao cadastrar professor!";
      }
    } catch (err) {
      console.error(err);
      professorMsg.textContent = "Erro na conexão!";
    }
  });
</script>

{% endblock %}
